* Xcode 11.5 produces incorrect code-coverage for modules built with `wholemodule` optimisation

Radar: TBD

After switching to Xcode 11.5 we noticed that code-coverage started to produce unpredictable results to us. The investigation showed that ~xccov~ generated unreliable results when a module built with ~wholemodule~ option for ~SWIFT_COMPILATION_MODE~.

This repository provides a minimal example to reproduce the issue.

* How does it work

There is a ~check_coverage.sh~ script that executes the following steps:

1. Checkout [[https://github.com/CocoaLumberjack/CocoaLumberjack][CocoaLumberjack]] repository to use it as an example project
2. Run tests twice with different ~SWIFT_COMPILATION_MODE~ options and produce ~xcresult~ bundles
3. Show target coverage for both runs
4. Show diff between runs compiled with ~incremental~ and ~wholemodule~ options

* Results

As you can see from the table below, ~xccov~ fails to count functions (classes?) properly when a module compiled with ~wholemodule~ optimisation. With the ~wholemodule~ option, only one file is tracked as covered with unit-tests.

|-------------------------------+----------+--------------+---------------------------|
| SWIFT_COMPILATION_MODE option | Coverage | Source files | Functions (covered/total) |
|-------------------------------+----------+--------------+---------------------------|
| incremental                   |   53.52% |            3 | 76/142                    |
| wholemodule                   |  100.00% |            1 | 37/37                     |
|-------------------------------+----------+--------------+---------------------------|

This is a diff produced by ~xccov diff~ command between reports produces for ~incremental~ and ~wholemodule~ :

#+begin_src json
  {
      "addedTargets": [],
      "lineCoverageDelta": {
          "coveredLinesDelta": -39,
          "executableLinesDelta": -105,
          "lineCoverageDelta": 0.46478873239436624
      },
      "removedTargets": [],
      "targetDeltas": [
          {
              "addedFiles": [],
              "fileDeltas": [],
              "lineCoverageDelta": {
                  "coveredLinesDelta": -39,
                  "executableLinesDelta": -105,
                  "lineCoverageDelta": 0.46478873239436624
              },
              "name": "CocoaLumberjackSwift.framework",
              "removedFiles": [
                  {
                      "documentLocation": "/Users/dive/radar-xcode-11-5-code-coverage-issue/CocoaLumberjack/Sources/CocoaLumberjackSwift/CocoaLumberjack.swift"
                  },
                  {
                      "documentLocation": "/Users/dive/radar-xcode-11-5-code-coverage-issue/CocoaLumberjack/Sources/CocoaLumberjackSwift/DDAssert.swift"
                  }
              ]
          }
      ]
  }
#+end_src

#+begin_src diff
  --- #<buffer *json-comparison-incremental*>
  +++ #<buffer *json-comparison-wholemodule*>
  @@ -1,262 +1,12 @@
   {
  -  "coveredLines": 76,
  -  "lineCoverage": 0.5352112676056338,
  +  "coveredLines": 37,
  +  "lineCoverage": 1,
     "targets": [
       {
  -      "coveredLines": 76,
  -      "lineCoverage": 0.5352112676056338,
  +      "coveredLines": 37,
  +      "lineCoverage": 1,
         "files": [
           {
  -          "coveredLines": 0,
  -          "lineCoverage": 0,
  -          "path": "/Users/dive/radar-xcode-11-5-code-coverage-issue/CocoaLumberjack/Sources/CocoaLumberjackSwift/DDAssert.swift",
  -          "functions": [
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 32,
  -              "executionCount": 0,
  -              "name": "implicit closure #1 () -> Swift.String in default argument 1 of CocoaLumberjackSwift.DDAssert(_: @autoclosure () -> Swift.Bool, _: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 32,
  -              "executionCount": 0,
  -              "name": "CocoaLumberjackSwift.DDAssert(_: @autoclosure () -> Swift.Bool, _: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 6
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 34,
  -              "executionCount": 0,
  -              "name": "implicit closure #1 () -> Swift.String in CocoaLumberjackSwift.DDAssert(_: @autoclosure () -> Swift.Bool, _: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 35,
  -              "executionCount": 0,
  -              "name": "implicit closure #2 () -> Swift.String in CocoaLumberjackSwift.DDAssert(_: @autoclosure () -> Swift.Bool, _: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 47,
  -              "executionCount": 0,
  -              "name": "implicit closure #1 () -> Swift.String in default argument 0 of CocoaLumberjackSwift.DDAssertionFailure(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 47,
  -              "executionCount": 0,
  -              "name": "CocoaLumberjackSwift.DDAssertionFailure(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 4
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 48,
  -              "executionCount": 0,
  -              "name": "implicit closure #1 () -> Swift.String in CocoaLumberjackSwift.DDAssertionFailure(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 49,
  -              "executionCount": 0,
  -              "name": "implicit closure #2 () -> Swift.String in CocoaLumberjackSwift.DDAssertionFailure(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            }
  -          ],
  -          "name": "DDAssert.swift",
  -          "executableLines": 16
  -        },
  -        {
  -          "coveredLines": 39,
  -          "lineCoverage": 0.43820224719101125,
  -          "path": "/Users/dive/radar-xcode-11-5-code-coverage-issue/CocoaLumberjack/Sources/CocoaLumberjackSwift/CocoaLumberjack.swift",
  -          "functions": [
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 22,
  -              "executionCount": 0,
  -              "name": "static (extension in CocoaLumberjackSwift):__C.DDLogFlag.from(__C.DDLogLevel) -> __C.DDLogFlag",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 26,
  -              "executionCount": 0,
  -              "name": "(extension in CocoaLumberjackSwift):__C.DDLogFlag.init(__C.DDLogLevel) -> __C.DDLogFlag",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 31,
  -              "executionCount": 0,
  -              "name": "(extension in CocoaLumberjackSwift):__C.DDLogFlag.toLogLevel() -> __C.DDLogLevel",
  -              "executableLines": 19
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 58,
  -              "executionCount": 0,
  -              "name": "CocoaLumberjackSwift.resetDynamicLogLevel() -> ()",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 64,
  -              "executionCount": 0,
  -              "name": "CocoaLumberjackSwift.defaultDebugLevel.getter : __C.DDLogLevel",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 67,
  -              "executionCount": 0,
  -              "name": "CocoaLumberjackSwift.defaultDebugLevel.setter : __C.DDLogLevel",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 73,
  -              "executionCount": 0,
  -              "name": "CocoaLumberjackSwift.resetDefaultDebugLevel() -> ()",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 18,
  -              "lineCoverage": 1,
  -              "lineNumber": 90,
  -              "executionCount": 10,
  -              "name": "CocoaLumberjackSwift._DDLogMessage(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, flag: __C.DDLogFlag, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 18
  -            },
  -            {
  -              "coveredLines": 1,
  -              "lineCoverage": 1,
  -              "lineNumber": 93,
  -              "executionCount": 10,
  -              "name": "implicit closure #1 () throws -> Swift.Bool in CocoaLumberjackSwift._DDLogMessage(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, flag: __C.DDLogFlag, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 3,
  -              "lineCoverage": 1,
  -              "lineNumber": 118,
  -              "executionCount": 2,
  -              "name": "CocoaLumberjackSwift.DDLogDebug(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 1,
  -              "lineCoverage": 1,
  -              "lineNumber": 119,
  -              "executionCount": 2,
  -              "name": "implicit closure #1 () -> Swift.String in CocoaLumberjackSwift.DDLogDebug(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 3,
  -              "lineCoverage": 1,
  -              "lineNumber": 131,
  -              "executionCount": 2,
  -              "name": "CocoaLumberjackSwift.DDLogInfo(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 1,
  -              "lineCoverage": 1,
  -              "lineNumber": 132,
  -              "executionCount": 2,
  -              "name": "implicit closure #1 () -> Swift.String in CocoaLumberjackSwift.DDLogInfo(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 3,
  -              "lineCoverage": 1,
  -              "lineNumber": 144,
  -              "executionCount": 2,
  -              "name": "CocoaLumberjackSwift.DDLogWarn(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 1,
  -              "lineCoverage": 1,
  -              "lineNumber": 145,
  -              "executionCount": 2,
  -              "name": "implicit closure #1 () -> Swift.String in CocoaLumberjackSwift.DDLogWarn(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 3,
  -              "lineCoverage": 1,
  -              "lineNumber": 157,
  -              "executionCount": 2,
  -              "name": "CocoaLumberjackSwift.DDLogVerbose(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 1,
  -              "lineCoverage": 1,
  -              "lineNumber": 158,
  -              "executionCount": 2,
  -              "name": "implicit closure #1 () -> Swift.String in CocoaLumberjackSwift.DDLogVerbose(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 3,
  -              "lineCoverage": 1,
  -              "lineNumber": 170,
  -              "executionCount": 2,
  -              "name": "CocoaLumberjackSwift.DDLogError(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 3
  -            },
  -            {
  -              "coveredLines": 1,
  -              "lineCoverage": 1,
  -              "lineNumber": 171,
  -              "executionCount": 2,
  -              "name": "implicit closure #1 () -> Swift.String in CocoaLumberjackSwift.DDLogError(_: @autoclosure () -> Swift.String, level: __C.DDLogLevel, context: Swift.Int, file: Swift.StaticString, function: Swift.StaticString, line: Swift.UInt, tag: Swift.Optional<Any>, asynchronous: Swift.Bool, ddlog: __C.DDLog) -> ()",
  -              "executableLines": 1
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 177,
  -              "executionCount": 0,
  -              "name": "CocoaLumberjackSwift.currentFileName(Swift.StaticString) -> Swift.String",
  -              "executableLines": 10
  -            },
  -            {
  -              "coveredLines": 0,
  -              "lineCoverage": 0,
  -              "lineNumber": 191,
  -              "executionCount": 0,
  -              "name": "CocoaLumberjackSwift.CurrentFileName(Swift.StaticString) -> Swift.String",
  -              "executableLines": 3
  -            }
  -          ],
  -          "name": "CocoaLumberjack.swift",
  -          "executableLines": 89
  -        },
  -        {
             "coveredLines": 37,
             "lineCoverage": 1,
             "path": "/Users/dive/radar-xcode-11-5-code-coverage-issue/CocoaLumberjack/Sources/CocoaLumberjackSwift/DDLog+Combine.swift",
  @@ -347,9 +97,9 @@
           }
         ],
         "name": "CocoaLumberjackSwift.framework",
  -      "executableLines": 142,
  +      "executableLines": 37,
         "buildProductPath": "/Users/dive/Library/Developer/Xcode/DerivedData/Tests-gmblgsocajwheadmsmociuoitafr/Build/Products/Debug-maccatalyst/CocoaLumberjackSwift.framework/Versions/A/CocoaLumberjackSwift"
       }
     ],
  -  "executableLines": 142
  +  "executableLines": 37
   }
  \ No newline at end of file

  Diff finished.  Wed Jun  3 13:23:58 2020
#+end_src

* Notes

- The script generates coverage for targets only. You can change it by removing ~--only-targets~ option from ~produceCodeCoverage~ function
- The script cleans up the CocoaLumberjack repository after each run and removes the ~xcresult~ bundles (check ~cleanUp~ function if you want to change it)
